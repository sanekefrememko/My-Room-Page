<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моя музыка</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .track-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .track-cover {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
        }
        .track-info {
            flex: 1;
        }
        .loading { color: #6c757d; }
        .error { color: #dc3545; }
        .track-link {
            display: inline-block;
            margin-top: 10px;
            color: #0d6efd;
            text-decoration: none;
        }
        .track-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>Сейчас играет:</h1>
    <div id="track-container" class="track-container">
        <img id="track-cover" class="track-cover" src="https://via.placeholder.com/150" alt="Обложка трека">
        <div class="track-info">
            <p>Артист: <span id="artist" class="loading">Загрузка...</span></p>
            <p>Трек: <span id="track" class="loading">Загрузка...</span></p>
            <a id="track-url" class="track-link" href="#" target="_blank">Слушать в Яндекс.Музыке</a>
        </div>
    </div>

    <!-- Подключаем Supabase через CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.6"></script>
    
    <script>
        // Конфигурация (ЗАМЕНИТЕ НА СВОИ ДАННЫЕ)
        const SUPABASE_URL = 'https://gaxylnqojebengfduqpp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdheHlsbnFvamViZW5nZmR1cXBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMTM5MzQsImV4cCI6MjA2MDg4OTkzNH0.Uz1zHc4-k8PPftgCG1EXw6PTloVOmPXDNRFoqhotzpA';
        
        // Основная функция инициализации
        async function initApp() {
            try {
                // 1. Инициализация клиента Supabase
                const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // 2. Первая загрузка данных
                await loadTrack(supabase);
                
                // 3. Настройка периодического обновления (каждые 30 сек)
                setInterval(async () => {
                    await loadTrack(supabase);
                }, 30000);
                
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                showError();
            }
        }
        
        // Загрузка данных о треке
        async function loadTrack(supabase) {
            try {
                const { data, error } = await supabase
                    .from('Tracks')
                    .select('artist, track, cover, url')
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                // Проверяем, есть ли данные
                if (!data || data.length === 0) {
                    throw new Error('Нет данных о треке');
                }
                
                updateUI(data[0]);
                
            } catch (error) {
                console.error('Ошибка загрузки трека:', error);
                showError();
            }
        }
        
        // Обновление интерфейса
        function updateUI(track) {
            document.getElementById('artist').textContent = track.artist || 'Неизвестно';
            document.getElementById('track').textContent = track.track || 'Неизвестно';
            
            // Обновляем обложку
            const coverImg = document.getElementById('track-cover');
            if (track.cover) {
                coverImg.src = track.cover;
                coverImg.alt = `${track.artist} - ${track.track}`;
            }
            
            // Обновляем ссылку
            const trackLink = document.getElementById('track-url');
            if (track.url) {
                trackLink.href = track.url;
                trackLink.style.display = 'inline-block';
            } else {
                trackLink.style.display = 'none';
            }
            
            // Убираем классы loading
            document.getElementById('artist').className = '';
            document.getElementById('track').className = '';
        }
        
        // Показать ошибку
        function showError() {
            document.getElementById('artist').textContent = 'Ошибка загрузки';
            document.getElementById('track').textContent = 'Ошибка загрузки';
            
            document.getElementById('artist').className = 'error';
            document.getElementById('track').className = 'error';
            
            document.getElementById('track-url').style.display = 'none';
        }
        
        // Запускаем приложение после загрузки страницы
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
